# PVLib Integration Module - Status Report

**Data**: 2025-10-12  
**M√≥dulo**: `backend/src/modules/pvlib-integration`  
**Objetivo**: Integra√ß√£o com servi√ßos PV externos (irradi√¢ncia/efici√™ncia) + Schemas locais (Sandia/CEC)

---

## üìä Status Geral

| Componente | Status | Linhas | Testes | Observa√ß√£o |
|-----------|--------|--------|--------|------------|
| **Types** | ‚úÖ Completo | ~227 | N/A | Enums, configs, errors |
| **HTTP Client** | ‚úÖ Completo | ~418 | ‚ö†Ô∏è 6 erros | Retry, backoff, circuit breaker |
| **Unit Normalizer** | ‚úÖ Completo | ~158 | ‚úÖ 15 testes | Convers√µes W/m¬≤, ¬∞C, %, kWh |
| **Service (Local)** | ‚úÖ Existente | ~387 | ‚ùì N√£o encontrados | Schemas Sandia/CEC locais |
| **Service (External)** | ‚ùå N√£o criado | 0 | 0 | Falta criar para APIs externas |
| **Index/Export** | ‚úÖ Completo | ~7 | N/A | M√≥dulo exportado |

---

## ‚úÖ Componentes Implementados

### 1. Types (`src/types/pvlib/index.ts`) - ‚úÖ COMPLETO

**Enums**:
- `PVDataProvider`: PVGIS, NREL, SOLCAST, METEONORM
- `DataType`: IRRADIANCE, EFFICIENCY, TEMPERATURE, WEATHER
- `Unit`: W/m¬≤, kW/m¬≤, MJ/m¬≤, Wh, kWh, MWh, ¬∞C, ¬∞F, K, %, decimal
- `CircuitState`: CLOSED, OPEN, HALF_OPEN

**Interfaces**:
- `CacheConfig`: TTL 24h configur√°vel
- `RetryConfig`: Exponential backoff com jitter
- `TimeoutConfig`: Connect, request, total timeouts
- `CircuitBreakerConfig`: Failure/success thresholds
- `PVDataRequest/Response`: Requisi√ß√£o/resposta normalizadas
- `ResilienceMetrics`: Tracking de performance (p95, p99, cache hits)

**Custom Errors**:
- `PVProviderError`: Erros de provider com statusCode
- `CircuitBreakerOpenError`: Circuito aberto com retry timestamp

---

### 2. HTTP Client (`client/http-client.ts`) - ‚úÖ COMPLETO

**Features Implementadas**:

#### Retry com Exponential Backoff
```typescript
private async fetchWithRetry(request: PVDataRequest): Promise<PVDataResponse> {
  let delay = this.config.retry.initial_delay_ms;
  
  for (let attempt = 1; attempt <= max_attempts; attempt++) {
    try {
      return await this.doFetch(request);
    } catch (error) {
      // Jitter: ¬±30% da delay
      const actualDelay = Math.min(delay + jitter, max_delay_ms);
      await this.sleep(actualDelay);
      delay *= backoff_multiplier; // 2x
    }
  }
}
```

**Configura√ß√£o Padr√£o**:
- `max_attempts: 3`
- `initial_delay_ms: 100`
- `max_delay_ms: 1000`
- `backoff_multiplier: 2`
- `retryable_status_codes: [429, 503, 504]`

#### Circuit Breaker
```typescript
// State Machine: CLOSED ‚Üí OPEN ‚Üí HALF_OPEN ‚Üí CLOSED
private circuitState: CircuitState = CircuitState.CLOSED;
private consecutiveFailures = 0;
private consecutiveSuccesses = 0;

// CLOSED ‚Üí OPEN ap√≥s N falhas
if (consecutiveFailures >= failure_threshold) {
  this.circuitState = CircuitState.OPEN;
}

// OPEN ‚Üí HALF_OPEN ap√≥s timeout
if (Date.now() - circuitOpenedAt >= timeout_ms) {
  this.circuitState = CircuitState.HALF_OPEN;
}

// HALF_OPEN ‚Üí CLOSED ap√≥s M sucessos
if (consecutiveSuccesses >= success_threshold) {
  this.circuitState = CircuitState.CLOSED;
}
```

**Configura√ß√£o Padr√£o**:
- `failure_threshold: 3` (3 falhas consecutivas ‚Üí OPEN)
- `success_threshold: 2` (2 sucessos em HALF_OPEN ‚Üí CLOSED)
- `timeout_ms: 60000` (1 min em OPEN antes de tentar HALF_OPEN)

#### Cache de 24h
```typescript
private cache: Map<string, { data: PVDataResponse; expires_at: number }>;

// Cache key: lat:lon:dataTypes:start:end
private getCacheKey(request: PVDataRequest): string {
  return `${prefix}:${latitude}:${longitude}:${data_types.join(",")}:${start_date}:${end_date}`;
}

// TTL padr√£o: 86400 segundos (24h)
const expires_at = Date.now() + ttl_seconds * 1000;
```

**Limpeza autom√°tica**: `setInterval(() => cleanExpiredCache(), 3600000)` (1 hora)

#### Timeouts Configur√°veis
```typescript
const controller = new AbortController();
const timeoutId = setTimeout(
  () => controller.abort(),
  request_timeout_ms
);

const response = await fetch(url, {
  signal: controller.signal
});
```

**Configura√ß√£o Padr√£o**:
- `request_timeout_ms: 10000` (10s por request)
- `connect_timeout_ms: 5000` (5s para connect)
- `total_timeout_ms: 30000` (30s incluindo retries)

#### M√©tricas de Observabilidade
```typescript
interface ResilienceMetrics {
  circuit_state: CircuitState;
  total_requests: number;
  failed_requests: number;
  cached_responses: number;
  average_response_time_ms: number;
  p95_response_time_ms: number; // Percentil 95
  p99_response_time_ms: number; // Percentil 99
}

// Calcula percentis mantendo √∫ltimas 1000 medi√ß√µes
const sortedTimes = [...response_times].sort((a, b) => a - b);
const p95Index = Math.floor(sortedTimes.length * 0.95);
```

**Provider-Specific URL Building**:
```typescript
switch (provider) {
  case "pvgis":
    return `${base_url}/PVcalc?lat=${lat}&lon=${lon}&outputformat=json`;
  case "nrel":
    return `${base_url}/solar/solar_resource/v1.json?lat=${lat}&lon=${lon}`;
  case "solcast":
    return `${base_url}/world_radiation/estimated_actuals?latitude=${lat}&longitude=${lon}`;
}
```

---

### 3. Unit Normalizer (`client/unit-normalizer.ts`) - ‚úÖ COMPLETO

**Convers√µes Implementadas**:

#### Irradi√¢ncia ‚Üí W/m¬≤
```typescript
static normalizeIrradiance(value: number, fromUnit: Unit): number {
  switch (fromUnit) {
    case Unit.W_PER_M2:
      return value; // Padr√£o SI
    case Unit.KW_PER_M2:
      return value * 1000;
    case Unit.MJ_PER_M2:
      // MJ/m¬≤/day ‚Üí W/m¬≤ (averaged over 24h)
      return (value * 1000000) / (24 * 3600);
  }
}
```

**Exemplo**: 20 MJ/m¬≤/day = 231.48 W/m¬≤

#### Energia ‚Üí kWh
```typescript
static normalizeEnergy(value: number, fromUnit: Unit): number {
  switch (fromUnit) {
    case Unit.KWH:
      return value; // Padr√£o
    case Unit.WH:
      return value / 1000;
    case Unit.MWH:
      return value * 1000;
  }
}
```

#### Temperatura ‚Üí ¬∞C
```typescript
static normalizeTemperature(value: number, fromUnit: Unit): number {
  switch (fromUnit) {
    case Unit.CELSIUS:
      return value;
    case Unit.FAHRENHEIT:
      return ((value - 32) * 5) / 9;
    case Unit.KELVIN:
      return value - 273.15;
  }
}
```

#### Efici√™ncia ‚Üí % (0-100)
```typescript
static normalizeEfficiency(value: number, fromUnit: Unit): number {
  switch (fromUnit) {
    case Unit.PERCENT:
      return value;
    case Unit.DECIMAL:
      return value * 100; // 0.185 ‚Üí 18.5%
  }
}
```

**Detec√ß√£o Autom√°tica de Unidades**:
```typescript
static detectUnit(unitString: string): Unit {
  const normalized = unitString.toLowerCase().trim();
  
  // Irradi√¢ncia
  if (normalized.includes("w/m") || normalized === "wm2") {
    return Unit.W_PER_M2;
  }
  
  // Temperatura
  if (normalized === "c" || normalized === "celsius" || normalized === "¬∞c") {
    return Unit.CELSIUS;
  }
  
  // ... outros casos
}
```

**Auto-Normalization Helpers**:
```typescript
// Detecta unidade da string e converte
UnitNormalizer.autoNormalizeIrradiance(1.2, "kW/m¬≤"); // ‚Üí 1200 W/m¬≤
UnitNormalizer.autoNormalizeTemperature(86, "F");     // ‚Üí 30 ¬∞C
UnitNormalizer.autoNormalizeEfficiency(0.22, "decimal"); // ‚Üí 22%
```

---

### 4. Service Local (`service.ts`) - ‚úÖ EXISTENTE (Schemas Locais)

**Prop√≥sito**: Acesso a schemas **locais** PVLib (Sandia/CEC)

**Features**:
- Carrega `normalized_inverters_sandia_clean.json` (inverters)
- Carrega `normalized_panels_cec_clean.json` (pain√©is)
- Cache de 1 hora
- Valida√ß√£o MPPT (compatibilidade inversor/painel)
- Busca por pot√™ncia (¬±20% toler√¢ncia)

**N√ÉO √â** para APIs externas (PVGIS, NREL, Solcast).

**M√©todos**:
```typescript
class PVLibIntegrationService {
  loadInverters(): InverterPVLib[]
  loadPanels(): PanelPVLib[]
  getInverterById(id: string): InverterPVLib | null
  getPanelById(id: string): PanelPVLib | null
  validateMPPT(inverter, panel, modulesPerString): MPPTValidationResult
  findInvertersByPower(powerW, tolerance): InverterPVLib[]
  findPanelsByPower(powerW, tolerance): PanelPVLib[]
  getStats(): { inverters, panels, cache }
}
```

---

## ‚ö†Ô∏è Problemas Identificados

### 1. Testes do HTTP Client (6 erros de tipo)

**Erro**:
```
Argument of type '{ ok: true; json: () => Promise<...>; }' is not assignable to parameter of type 'Response'.
Type is missing properties: headers, redirected, status, statusText, and 10 more.
```

**Causa**: Mock parcial do Response n√£o tem todas propriedades.

**Solu√ß√£o**: Criar helper `createMockResponse()`:
```typescript
function createMockResponse(data: any, options: { status?: number; ok?: boolean } = {}): Response {
  return {
    ok: options.ok ?? true,
    status: options.status ?? 200,
    statusText: options.status === 400 ? "Bad Request" : "OK",
    json: async () => data,
    headers: new Headers(),
    redirected: false,
    type: "basic",
    url: "",
    clone: jest.fn(),
    body: null,
    bodyUsed: false,
    arrayBuffer: jest.fn(),
    blob: jest.fn(),
    formData: jest.fn(),
    text: jest.fn(),
  } as Response;
}
```

**Uso**:
```typescript
fetchMock.mockResolvedValueOnce(
  createMockResponse({ outputs: {} })
);
```

---

### 2. Arquitetura Dual (Confus√£o de Prop√≥sitos)

**Situa√ß√£o Atual**:
- `service.ts` ‚Üí Schemas **LOCAIS** (Sandia/CEC de arquivos JSON)
- `http-client.ts` ‚Üí APIs **EXTERNAS** (PVGIS, NREL via HTTP)

**Problema**: N√£o h√° service que **USE** o http-client para APIs externas.

**Solu√ß√µes Poss√≠veis**:

#### Op√ß√£o A: Criar ExternalPVDataService
```typescript
class ExternalPVDataService extends MedusaService({}) {
  private clients: Map<PVDataProvider, PVHttpClient>;
  
  async fetchIrradiance(lat, lon): Promise<IrradianceData[]> {
    // Usa http-client para buscar de PVGIS/NREL
  }
  
  async fetchWithFailover(request): Promise<PVDataResponse> {
    // Tenta primary, depois fallbacks
  }
}
```

#### Op√ß√£o B: Renomear Service Existente
```typescript
// Atual: PVLibIntegrationService (schemas locais)
// Renomear para: PVLibSchemaService

// Novo: PVLibExternalDataService (APIs HTTP)
```

#### Op√ß√£o C: Unificar em Service √önico
```typescript
class PVLibIntegrationService {
  // Schemas locais
  loadInverters()
  loadPanels()
  
  // APIs externas (novo)
  fetchExternalIrradiance()
  fetchExternalEfficiency()
}
```

---

## üìã Tasks Remanescentes

### üî¥ Prioridade Alta (Bloqueantes)

1. **Corrigir Testes do HTTP Client** (30 min)
   - Criar helper `createMockResponse()`
   - Substituir todos mocks parciais por mocks completos
   - Rodar `yarn test:unit http-client.unit.spec.ts`
   - **Aceite**: 0 erros de tipo, todos testes passam

2. **Decidir Arquitetura** (15 min - decis√£o)
   - Op√ß√£o A: Criar `ExternalPVDataService` separado
   - Op√ß√£o B: Renomear existente + criar novo
   - Op√ß√£o C: Unificar em service √∫nico
   - **Recomenda√ß√£o**: Op√ß√£o A (separa√ß√£o de responsabilidades)

3. **Implementar ExternalPVDataService** (45 min)
   ```typescript
   class ExternalPVDataService extends MedusaService({}) {
     private httpClient: PVHttpClient;
     
     async fetchIrradiance(request: PVDataRequest): Promise<PVDataResponse> {
       return this.httpClient.fetchData(request);
     }
     
     async fetchWithFailover(request: PVDataRequest, fallbackProviders: PVDataProvider[]): Promise<PVDataResponse> {
       // Implementa l√≥gica de failover
     }
     
     getMetrics(): ResilienceMetrics {
       return this.httpClient.getMetrics();
     }
   }
   ```
   - Exportar em `index.ts`
   - Registrar em `medusa-config.ts`

### üü° Prioridade M√©dia (Melhoria)

4. **Testes de Integra√ß√£o com MSW** (60 min)
   - Instalar `msw` (Mock Service Worker)
   - Criar handlers para PVGIS, NREL
   - Testar timeout handling
   - Testar circuit breaker transitions
   - **Aceite**: Simular falhas reais, verificar retry/backoff

5. **Documenta√ß√£o da Arquitetura** (30 min)
   - Criar `backend/src/modules/pvlib-integration/README.md`
   - Explicar dual architecture:
     - **Local Schemas** (Sandia/CEC) ‚Üí `PVLibIntegrationService`
     - **External APIs** (PVGIS/NREL) ‚Üí `ExternalPVDataService` + `PVHttpClient`
   - Quando usar cada um
   - Exemplos de uso

6. **Normalizer para Providers Espec√≠ficos** (45 min)
   - Criar `client/normalizers/pvgis-normalizer.ts`
   - Criar `client/normalizers/nrel-normalizer.ts`
   - Implementar parsing de respostas espec√≠ficas
   - Mapear para `PVDataResponse` padronizado

### üü¢ Prioridade Baixa (Futuro)

7. **M√©tricas Prometheus** (30 min)
   - Expor m√©tricas do circuit breaker
   - Expor p95/p99 response times
   - Expor cache hit rate

8. **Admin UI para M√©tricas** (120 min)
   - Dashboard com estado dos providers
   - Gr√°fico de response times
   - Alertas de circuit breaker OPEN

9. **Scheduled Job para Health Check** (30 min)
   - Job a cada 5 min verificando sa√∫de dos providers
   - Notifica se algum provider est√° OPEN h√° > 15 min

---

## üß™ Cobertura de Testes

| Arquivo | Testes | Status | Cobertura |
|---------|--------|--------|-----------|
| `unit-normalizer.unit.spec.ts` | 15 | ‚úÖ PASSA | ~95% |
| `http-client.unit.spec.ts` | 11 | ‚ö†Ô∏è 6 erros de tipo | 0% (n√£o roda) |
| `service.ts` (local) | ‚ùì N√£o encontrados | - | ‚ùì |

**Testes do Unit Normalizer** (15 casos):
- ‚úÖ Irradiance: W/m¬≤, kW/m¬≤, MJ/m¬≤, zero values
- ‚úÖ Energy: kWh, Wh, MWh
- ‚úÖ Temperature: ¬∞C, ¬∞F, K, freezing point, negatives
- ‚úÖ Efficiency: %, decimal, 100% edge case
- ‚úÖ Unit Detection: v√°rios formatos, case-insensitive
- ‚úÖ Auto-normalization: from string
- ‚úÖ Edge cases: large values, whitespace

**Testes do HTTP Client** (11 casos, todos pendentes):
- ‚è≥ Retry on 503
- ‚è≥ NO retry on 400
- ‚è≥ Respect max_attempts
- ‚è≥ Circuit breaker OPEN after failures
- ‚è≥ Reject when OPEN
- ‚è≥ Transition OPEN ‚Üí HALF_OPEN (placeholder)
- ‚è≥ CLOSE after successes (placeholder)
- ‚è≥ Cache successful responses
- ‚è≥ Respect cache TTL (placeholder)
- ‚è≥ Different cache keys for locations
- ‚è≥ Timeout handling
- ‚è≥ Track metrics

---

## üöÄ Pr√≥ximos Passos Recomendados

### Sprint 1 (2 horas)
1. ‚úÖ Corrigir testes do HTTP client (30 min)
2. ‚úÖ Decidir arquitetura (15 min)
3. ‚úÖ Implementar ExternalPVDataService (45 min)
4. ‚úÖ Rodar testes unit√°rios completos (15 min)
5. ‚úÖ Documentar arquitetura dual (15 min)

### Sprint 2 (3 horas)
6. Testes de integra√ß√£o com MSW (60 min)
7. Normalizers espec√≠ficos por provider (90 min)
8. Registrar em medusa-config.ts (15 min)
9. Criar exemplo de uso no README (15 min)

### Sprint 3 (Futuro)
10. M√©tricas Prometheus
11. Admin UI
12. Scheduled health checks

---

## üìä M√©tricas de Qualidade

| M√©trica | Valor | Meta | Status |
|---------|-------|------|--------|
| Cobertura de Testes | ~47% | 80% | üü° |
| Erros de Lint | 6 | 0 | üî¥ |
| Tempo de Response (p95) | N/A | <2s | ‚è≥ |
| Cache Hit Rate | N/A | >60% | ‚è≥ |
| Circuit Breaker Funcionando | ‚úÖ Implementado | Sim | üü¢ |
| Retry com Backoff | ‚úÖ Implementado | Sim | üü¢ |
| Normaliza√ß√£o de Unidades | ‚úÖ Implementado | Sim | üü¢ |

---

## üí° Recomenda√ß√µes Arquiteturais

### Separa√ß√£o Clara de Responsabilidades

```
pvlib-integration/
‚îú‚îÄ‚îÄ service.ts              # Schemas LOCAIS (Sandia/CEC)
‚îú‚îÄ‚îÄ external-service.ts     # APIs EXTERNAS (PVGIS/NREL) ‚Üê CRIAR
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îú‚îÄ‚îÄ http-client.ts      # HTTP resiliente
‚îÇ   ‚îú‚îÄ‚îÄ unit-normalizer.ts  # Convers√µes
‚îÇ   ‚îî‚îÄ‚îÄ normalizers/        # Provider-specific ‚Üê CRIAR
‚îÇ       ‚îú‚îÄ‚îÄ pvgis.ts
‚îÇ       ‚îú‚îÄ‚îÄ nrel.ts
‚îÇ       ‚îî‚îÄ‚îÄ solcast.ts
‚îî‚îÄ‚îÄ __tests__/
    ‚îú‚îÄ‚îÄ service.unit.spec.ts
    ‚îú‚îÄ‚îÄ external-service.unit.spec.ts
    ‚îú‚îÄ‚îÄ http-client.unit.spec.ts (FIX)
    ‚îî‚îÄ‚îÄ unit-normalizer.unit.spec.ts (OK)
```

### Quando Usar Cada Service

**Use `PVLibIntegrationService` (schemas locais)**:
- Buscar par√¢metros Sandia de inversor
- Buscar par√¢metros CEC de painel
- Validar compatibilidade MPPT
- Dados offline (sem internet)

**Use `ExternalPVDataService` (APIs externas)**:
- Buscar irradi√¢ncia solar de location
- Buscar dados meteorol√≥gicos em tempo real
- Simula√ß√µes com dados atualizados
- Requires internet/API keys

---

**√öltima Atualiza√ß√£o**: 2025-10-12  
**Pr√≥xima Revis√£o**: Ap√≥s Sprint 1 completar  
**Respons√°vel**: Staff Backend Engineer
