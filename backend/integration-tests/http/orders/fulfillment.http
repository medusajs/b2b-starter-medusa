### ========================================
### Order Fulfillment API - PLG Product Tracking & Real-Time Transparency Tests
### ========================================

@baseUrl = http://localhost:9000
@adminToken = YOUR_ADMIN_TOKEN_HERE
@customerToken = YOUR_CUSTOMER_TOKEN_HERE
@orderId = order_01JKA3M8FQWX2HPZY7V5NRTBK1

### ========================================
### 1. GET /store/orders/:id/fulfillment
### Fetch fulfillment with product tracking + real-time events (PLG: 360Â° transparency)
### ========================================
GET {{baseUrl}}/store/orders/{{orderId}}/fulfillment
Content-Type: application/json
Authorization: Bearer {{customerToken}}

### Expected Response (200):
# {
#   "fulfillment_id": "fulfill_01JKA...",
#   "order_id": "order_01JKA...",
#   "status": "shipped",
#   "warehouse": {
#     "id": "wh_01JKA...",
#     "name": "YSH Store - Centro de DistribuiÃ§Ã£o SP"
#   },
#   "picking": {
#     "started_at": "2025-10-12T08:00:00Z",
#     "completed_at": "2025-10-12T09:30:00Z",
#     "picked_by": "JoÃ£o Silva"
#   },
#   "packing": {
#     "started_at": "2025-10-12T09:30:00Z",
#     "completed_at": "2025-10-12T10:15:00Z",
#     "packed_by": "Maria Santos",
#     "number_of_packages": 2,
#     "package_dimensions": [
#       {
#         "width": 120,
#         "height": 80,
#         "depth": 20,
#         "weight": 35.5
#       },
#       {
#         "width": 60,
#         "height": 40,
#         "depth": 30,
#         "weight": 18.2
#       }
#     ]
#   },
#   "picked_items": [ // âœ… PLG: Product tracking with enrichment
#     {
#       "product_id": "prod_01HJKS...",
#       "variant_id": "variant_01HJKS...",
#       "title": "Kit Solar Completo 5.4 kWp - Deye Premium",
#       "quantity": 1,
#       "sku": "KIT-SOLAR-5.4-DEYE-001",
#       "location": "A-12-3",
#       "product": { // âœ… PLG: Product enrichment via query.graph()
#         "id": "prod_01HJKS...",
#         "title": "Kit Solar Completo 5.4 kWp - Deye Premium",
#         "thumbnail": "https://ysh-store.s3.amazonaws.com/products/kit-solar-5.4-deye.jpg",
#         "description": "Kit completo com 12 painÃ©is Deye 450W...",
#         "variants": [
#           {
#             "id": "variant_01HJKS...",
#             "sku": "KIT-SOLAR-5.4-DEYE-001",
#             "title": "Kit Solar 5.4 kWp - Deye - Com InstalaÃ§Ã£o",
#             "prices": [...]
#           }
#         ]
#       }
#     },
#     {
#       "product_id": "prod_01HJKS...",
#       "variant_id": "variant_01HJKS...",
#       "title": "Estrutura de FixaÃ§Ã£o para Telhado CerÃ¢mico",
#       "quantity": 1,
#       "sku": "EST-CERAMICO-5.4KW",
#       "location": "B-08-1",
#       "product": {
#         "id": "prod_01HJKS...",
#         "title": "Estrutura de FixaÃ§Ã£o para Telhado CerÃ¢mico",
#         "thumbnail": "https://...",
#         "variants": [...]
#       }
#     }
#   ],
#   "shipments": [ // âœ… PLG: Real-time shipping transparency
#     {
#       "shipment_id": "ship_01JKA...",
#       "tracking_code": "YSH-2025-0001234",
#       "tracking_url": "https://ysh-store.com.br/rastreio/YSH-2025-0001234",
#       "carrier": "Transportadora Total Express",
#       "service_type": "Entrega Agendada",
#       "status": "in_transit",
#       "shipped_at": "2025-10-12T11:00:00Z",
#       "estimated_delivery_date": "2025-10-15",
#       "actual_delivery_date": null,
#       "tracking_events": [ // âœ… PLG: Real-time event timeline
#         {
#           "timestamp": "2025-10-12T11:00:00Z",
#           "status": "picked_up",
#           "location": "SÃ£o Paulo - SP",
#           "description": "Objeto coletado no centro de distribuiÃ§Ã£o"
#         },
#         {
#           "timestamp": "2025-10-12T14:30:00Z",
#           "status": "in_transit",
#           "location": "SÃ£o Paulo - SP",
#           "description": "Objeto em trÃ¢nsito - saiu para entrega"
#         },
#         {
#           "timestamp": "2025-10-13T08:45:00Z",
#           "status": "in_transit",
#           "location": "Campinas - SP",
#           "description": "Objeto em trÃ¢nsito - prÃ³xima parada"
#         },
#         {
#           "timestamp": "2025-10-14T10:20:00Z",
#           "status": "out_for_delivery",
#           "location": "Campinas - SP",
#           "description": "Objeto saiu para entrega ao destinatÃ¡rio"
#         }
#       ],
#       "shipping_address": {
#         "street": "Rua das Flores, 123",
#         "neighborhood": "Centro",
#         "city": "Campinas",
#         "state": "SP",
#         "postal_code": "13010-000"
#       }
#     }
#   ]
# }

### ========================================
### 2. GET /store/orders/:id/fulfillment - Order with multiple shipments
### ========================================
@multiShipmentOrderId = order_01JKA3M8FQWX2HPZY7V5NRTBK2

GET {{baseUrl}}/store/orders/{{multiShipmentOrderId}}/fulfillment
Content-Type: application/json
Authorization: Bearer {{customerToken}}

### Note: Should return fulfillment with 2+ shipments (split delivery)

### ========================================
### 3. GET /store/orders/:id/fulfillment - Order in picking status
### ========================================
@pickingOrderId = order_01JKA3M8FQWX2HPZY7V5NRTBK3

GET {{baseUrl}}/store/orders/{{pickingOrderId}}/fulfillment
Content-Type: application/json
Authorization: Bearer {{customerToken}}

### Note: Should return fulfillment with status="picking", no shipments yet

### ========================================
### 4. GET /store/orders/:id/fulfillment - Order delivered
### ========================================
@deliveredOrderId = order_01JKA3M8FQWX2HPZY7V5NRTBK4

GET {{baseUrl}}/store/orders/{{deliveredOrderId}}/fulfillment
Content-Type: application/json
Authorization: Bearer {{customerToken}}

### Note: Should return fulfillment with status="delivered", shipment has actual_delivery_date and final tracking_event

### ========================================
### 5. GET /store/orders/:id/fulfillment - Error: Fulfillment not found
### ========================================
GET {{baseUrl}}/store/orders/invalid_order_id/fulfillment
Content-Type: application/json
Authorization: Bearer {{customerToken}}

### Expected Response (404):
# {
#   "error": "Fulfillment not found for this order",
#   "order_id": "invalid_order_id"
# }

### ========================================
### 6. GET /store/orders/:id/fulfillment - Error: Unauthorized
### ========================================
GET {{baseUrl}}/store/orders/{{orderId}}/fulfillment
Content-Type: application/json

### Expected Response (401):
# {
#   "error": "Unauthorized"
# }

### ========================================
### Validation Checklist (PLG Strategy 360Â°):
### ========================================
# âœ… OrderFulfillment entity queried via query.graph()
# âœ… OrderShipment entities fetched with fulfillment
# âœ… picked_items present (JSONB with product_id, variant_id, title, quantity, sku, location)
# âœ… Product enrichment via query.graph() (title, thumbnail, description, variants)
# âœ… tracking_code present (public identifier: YSH-2025-XXXXXXX)
# âœ… tracking_url present (customer-facing tracking page)
# âœ… tracking_events present (JSONB array with timestamp, status, location, description)
# âœ… Real-time status updates (picked_up, in_transit, out_for_delivery, delivered)
# âœ… Warehouse details (id, name)
# âœ… Picking details (started_at, completed_at, picked_by)
# âœ… Packing details (started_at, completed_at, packed_by, number_of_packages, package_dimensions)
# âœ… Carrier details (carrier, service_type)
# âœ… Delivery timeline (shipped_at, estimated_delivery_date, actual_delivery_date)
# âœ… Shipping address (full address details)
# âœ… 360Â° PLG Coverage: Stage 4 complete (fulfillment â†’ product tracking + real-time transparency)

### ========================================
### PLG Strategy 360Â° - Complete Journey Coverage:
### ========================================
# âœ… Stage 1: Solar Calculations â†’ Kits with product_id (integration-tests/http/solar/calculations.http)
# âœ… Stage 2: Credit Analysis â†’ 3 financing offers with modality/rates (integration-tests/http/credit-analysis/analyses.http)
# âœ… Stage 3: Financing Application â†’ Payment schedule with 360 installments (integration-tests/http/financing/applications.http)
# âœ… Stage 4: Order Fulfillment â†’ Product tracking + real-time events (THIS FILE)
#
# ðŸŽ‰ COMPLETE 360Â° PLG COVERAGE ACHIEVED! ðŸŽ‰
#
# Customer can now:
# 1. Calculate solar system â†’ See 5 kit recommendations with products
# 2. Analyze credit â†’ Compare 3 financing options with transparent rates
# 3. Apply for financing â†’ View complete payment schedule (up to 30 years)
# 4. Track order â†’ See products being fulfilled with real-time shipping events
#
# All touchpoints expose products, options, prices, and status for complete transparency!
