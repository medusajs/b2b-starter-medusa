# DIAGRAMAS: PAYMENT SYSTEM WITH ASAAS + SPLITS

## ğŸ“ ARQUITETURA DE ALTO NÃVEL

```tsx
â”Œâ”€â”€tsxâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Frontend)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Product Catalog  â”‚  â”‚ Payment Selector â”‚  â”‚ Split Breakdown  â”‚     â”‚
â”‚  â”‚ (Price Display)  â”‚  â”‚ (Method + Tier)  â”‚  â”‚ (Transparency)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEDUSA.JS API                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚            /api/payment/calculate (POST)                     â”‚      â”‚
â”‚  â”‚            /api/payment/methods (GET)                        â”‚      â”‚
â”‚  â”‚            /api/payment/split/create (POST)                  â”‚      â”‚
â”‚  â”‚            /api/payment/split/recipients (GET)               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WORKFLOWS & BUSINESS LOGIC                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚      calculatePaymentWithFeesWorkflow (6 Steps)              â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚  â”‚  â”‚ 1. Load Product + Cost Breakdown                       â”‚  â”‚      â”‚
â”‚  â”‚  â”‚ 2. Load Payment Gateway Config                         â”‚  â”‚      â”‚
â”‚  â”‚  â”‚ 3. Calculate Gateway Fees                              â”‚  â”‚      â”‚
â”‚  â”‚  â”‚ 4. Calculate Notification Fees                         â”‚  â”‚      â”‚
â”‚  â”‚  â”‚ 5. Calculate Advance Fees (optional)                   â”‚  â”‚      â”‚
â”‚  â”‚  â”‚ 6. Calculate Payment Splits                            â”‚  â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA MODELS                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PaymentGate â”‚  â”‚PaymentTrans â”‚  â”‚SplitRecipienâ”‚  â”‚SplitExecutionâ”‚  â”‚
â”‚  â”‚ way         â”‚  â”‚ action      â”‚  â”‚t            â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ (Fees)      â”‚  â”‚ (Txs)       â”‚  â”‚ (Recipients)â”‚  â”‚ (Repasses)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                 â”‚                 â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚SplitRule    â”‚  â”‚CostBreakdownâ”‚  â”‚ Product     â”‚  â”‚ Order       â”‚  â”‚
â”‚  â”‚(Split Logic)â”‚  â”‚(Custos JSON)â”‚  â”‚ Extension   â”‚  â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ASAAS API INTEGRATION                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Create Charge â”‚  â”‚ Webhooks     â”‚  â”‚ Transfers    â”‚  â”‚ Subaccountsâ”‚ â”‚
â”‚  â”‚ (Payment)    â”‚  â”‚ (Callbacks)  â”‚  â”‚ (Splits)     â”‚  â”‚ (R$12.90)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° FLUXO DE PAGAMENTO COM SPLITS

```tsx
Cliente                 YSH Platform              Asaas               Recipients
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 1. Seleciona produto   â”‚                      â”‚                      â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 2. Escolhe PIX         â”‚                      â”‚                      â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 3. Calculate Payment â”‚                      â”‚
   â”‚                         â”‚   (Workflow 6 steps) â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 4. Recebe breakdown    â”‚                      â”‚                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚
   â”‚   R$ 116,769.14        â”‚                      â”‚                      â”‚
   â”‚   (R$ 116,766.70 base  â”‚                      â”‚                      â”‚
   â”‚    + R$ 1.89 PIX       â”‚                      â”‚                      â”‚
   â”‚    + R$ 0.55 WhatsApp) â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 5. Confirma compra     â”‚                      â”‚                      â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 6. Create Charge    â”‚                      â”‚
   â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 7. QR Code PIX      â”‚                      â”‚
   â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 8. Recebe QR Code      â”‚                      â”‚                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 9. Escaneia QR + Paga  â”‚                      â”‚                      â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
   â”‚   R$ 116,769.14        â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 10. Webhook: confirmed                     â”‚
   â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 11. Create Split Execution                 â”‚
   â”‚                         â”‚   (4 recipients)     â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 12. Schedule Transfers (T+24h)             â”‚
   â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚ 13. Transfer: R$ 70,056.51
   â”‚                         â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                         â”‚                      â”‚     (FortLev)        â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚ 14. Transfer: R$ 23,349.81
   â”‚                         â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                         â”‚                      â”‚     (Dossier)        â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚ 15. Transfer: R$ 23,349.81
   â”‚                         â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                         â”‚                      â”‚     (Labor)          â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚                         â”‚ 16. Webhooks: transfer_completed           â”‚
   â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
   â”‚ 17. Recebe confirmaÃ§Ã£o â”‚                      â”‚                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚
   â”‚   "Pedido confirmado"  â”‚                      â”‚                      â”‚
   â”‚                         â”‚                      â”‚                      â”‚
```

---

## ğŸ”„ WORKFLOW: calculatePaymentWithFeesWorkflow

```tsx
INPUT                            STEP 1                    STEP 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚product_id     â”‚               â”‚Load Product   â”‚         â”‚Load Gateway   â”‚
â”‚distributor    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚+ Cost         â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚Config         â”‚
â”‚quantity       â”‚               â”‚Breakdown      â”‚         â”‚(Asaas Fees)   â”‚
â”‚payment_method â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚notifications  â”‚                       â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â–¼                         â–¼
                              {product, cost_breakdown}  {gateway_config}
                                       â”‚                         â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â–¼
                                    STEP 3: Calculate Gateway Fees
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ IF boleto: R$ 1.89      â”‚
                                    â”‚ IF credit_card:         â”‚
                                    â”‚   1x: 2.89%             â”‚
                                    â”‚   2-6x: 3.12%           â”‚
                                    â”‚   7-12x: 3.44%          â”‚
                                    â”‚   13-21x: 5.58%         â”‚
                                    â”‚ IF debit_card: 1.89%    â”‚
                                    â”‚ IF pix: R$ 1.89         â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    STEP 4: Calculate Notification Fees
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ email_sms: R$ 0.00      â”‚
                                    â”‚ whatsapp: R$ 0.55       â”‚
                                    â”‚ voice_robot: R$ 0.55    â”‚
                                    â”‚ mail: R$ 2.91           â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    STEP 5: Calculate Advance Fees (optional)
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ IF enable_advance:      â”‚
                                    â”‚   boleto: 4.19%/mÃªs     â”‚
                                    â”‚   credit: 1.89%/mÃªs     â”‚
                                    â”‚ ELSE: 0                 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    STEP 6: Calculate Splits
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ 1. Distributor          â”‚
                                    â”‚    = custo_kit_reais    â”‚
                                    â”‚ 2. Dossier              â”‚
                                    â”‚    = custo_dossie       â”‚
                                    â”‚ 3. Labor                â”‚
                                    â”‚    = custo_mao_de_obra  â”‚
                                    â”‚ 4. Platform             â”‚
                                    â”‚    = Remainder (~5%)    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    OUTPUT
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ total_with_fees_brl     â”‚
                                    â”‚ gateway_fee_total_brl   â”‚
                                    â”‚ splits[] (4 recipients) â”‚
                                    â”‚ total_splits_brl        â”‚
                                    â”‚ estimated_settlement    â”‚
                                    â”‚ cost_breakdown          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¸ SPLIT DISTRIBUTION (Visual)

```tsx
                    CLIENTE PAGA: R$ 116,769.14
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
              Gateway Fee          Valor LÃ­quido
               R$ 1.89            R$ 116,767.25
                    â”‚                   â”‚
                    â–¼                   â”‚
              YSH Platform              â”‚
             (absorve fee)              â”‚
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                               â”‚
                        â”‚    SPLITS BASEADOS EM CUSTOS  â”‚
                        â”‚                               â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                   â”‚                   â”‚                   â”‚
                â–¼                   â–¼                   â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ DISTRIBUTOR  â”‚    â”‚   DOSSIER    â”‚    â”‚    LABOR     â”‚  â”‚   PLATFORM   â”‚
        â”‚  (FortLev)   â”‚    â”‚  (Technical) â”‚    â”‚(Installation)â”‚  â”‚     (YSH)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                   â”‚                   â”‚
        R$ 70,060.00          R$ 23,353.30        R$ 23,353.30         R$ 0.10
        (59.99%)              (20.00%)            (20.00%)             (0.01%)
              â”‚                     â”‚                   â”‚                   â”‚
        - R$ 3.49             - R$ 3.49           - R$ 3.49           - R$ 0.00
        (transfer)            (transfer)          (transfer)          (conta principal)
              â”‚                     â”‚                   â”‚                   â”‚
              â–¼                     â–¼                   â–¼                   â–¼
        R$ 70,056.51          R$ 23,349.81        R$ 23,349.81         R$ 0.10
        (LÃQUIDO)             (LÃQUIDO)           (LÃQUIDO)            (LÃQUIDO)
```

**Total DistribuÃ­do:**

- Soma de splits: R$ 116,766.70 âœ…
- Gateway fee (YSH): R$ 1.89
- Notification fee: R$ 0.55
- **TOTAL: R$ 116,769.14** âœ…

**Transfer Fees (pagas pelos recipients):**

- 3Ã— R$ 3.49 = R$ 10.47 (para Asaas)

---

## ğŸ—„ï¸ DATABASE SCHEMA (Simplified)

```tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      payment_gateway            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                    PK        â”‚
â”‚ gateway_provider      VARCHAR   â”‚â”€â”€> "asaas"
â”‚ environment           VARCHAR   â”‚â”€â”€> "production"
â”‚ boleto_fee_brl        DECIMAL   â”‚â”€â”€> 1.89
â”‚ credit_card_fee_*     DECIMAL   â”‚â”€â”€> 2.89, 3.12, 3.44, 5.58
â”‚ pix_dynamic_fee_brl   DECIMAL   â”‚â”€â”€> 1.89
â”‚ whatsapp_fee_brl      DECIMAL   â”‚â”€â”€> 0.55
â”‚ ...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ (1:N)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      payment_transaction        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                    PK        â”‚
â”‚ payment_gateway_id    FK        â”‚â”€â”€â”€â”€> payment_gateway.id
â”‚ order_id              VARCHAR   â”‚
â”‚ payment_method        ENUM      â”‚â”€â”€> boleto, credit_card, pix
â”‚ amount_brl            DECIMAL   â”‚â”€â”€> 116769.14
â”‚ gateway_fee_brl       DECIMAL   â”‚â”€â”€> 1.89
â”‚ total_with_fees_brl   DECIMAL   â”‚â”€â”€> 116769.14
â”‚ asaas_charge_id       VARCHAR   â”‚â”€â”€> "chrg_xyz123"
â”‚ status                ENUM      â”‚â”€â”€> pending, confirmed, received
â”‚ ...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ (1:1)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    payment_split_execution      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                    PK        â”‚
â”‚ payment_transaction_id FK       â”‚â”€â”€â”€â”€> payment_transaction.id
â”‚ total_amount_brl      DECIMAL   â”‚â”€â”€> 116769.14
â”‚ gateway_fee_brl       DECIMAL   â”‚â”€â”€> 1.89
â”‚ net_amount_brl        DECIMAL   â”‚â”€â”€> 116767.25
â”‚ splits                JSON      â”‚â”€â”€> [{recipient, amount, fee, ...}, ...]
â”‚ total_splits_brl      DECIMAL   â”‚â”€â”€> 116766.70
â”‚ total_transfer_fees   DECIMAL   â”‚â”€â”€> 10.47
â”‚ status                ENUM      â”‚â”€â”€> pending, completed
â”‚ ...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ (N:M via splits JSON)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   payment_split_recipient       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                    PK        â”‚
â”‚ recipient_type        ENUM      â”‚â”€â”€> distributor, labor, platform
â”‚ recipient_code        VARCHAR   â”‚â”€â”€> FLV, NEO, FTS
â”‚ recipient_name        VARCHAR   â”‚â”€â”€> "FortLev Solar"
â”‚ asaas_account_id      VARCHAR   â”‚â”€â”€> "acc_xyz456"
â”‚ pix_key               VARCHAR   â”‚â”€â”€> "12345678000190"
â”‚ pix_key_type          ENUM      â”‚â”€â”€> cnpj, cpf, email, phone
â”‚ transfer_fee_brl      DECIMAL   â”‚â”€â”€> 3.49 (terceiros), 0.00 (YSH)
â”‚ active                BOOLEAN   â”‚â”€â”€> true
â”‚ ...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š COST BREAKDOWN STRUCTURE

```json
{
  "product_id": "prod_kit_jinko_12kwp",
  "distributor_code": "FLV",
  
  "custo_kit_reais": 70060.00,
  "custo_dossie_tecnico_homologacao_reais": 23353.30,
  "custo_mao_de_obra_reais": 23353.30,
  "valor_total_projeto_reais": 116766.67,
  
  "modulos_solares": [
    {
      "marca_do_modulo": "Jinko",
      "modelo_do_modulo": "Jinko 580W",
      "quantidade_de_unidades": 30,
      "preco_unitario_reais": 1875.0,
      "preco_total_modulos_reais": 56250.0
    }
  ],
  
  "inversor_solar": {
    "marca_do_inversor": "Growatt",
    "modelo_do_inversor": "MIC3000TL-X",
    "preco_unitario_reais": 1799.49,
    "quantidade_de_unidades": 10
  },
  
  "componentes_balance_of_system": {
    "custo_estrutura_montagem_reais": 11136.70,
    "custo_cabos_e_conectores_reais": 3712.20,
    "custo_protecoes_eletricas_reais": 2227.30,
    "custo_aterramento_reais": 742.40
  }
}
```

**Split Mapping:**

- `custo_kit_reais` â†’ **Distributor** (FortLev)
- `custo_dossie_tecnico_homologacao_reais` â†’ **Technical Dossier Provider**
- `custo_mao_de_obra_reais` â†’ **Labor Provider** (Instaladora)
- Remainder â†’ **Platform** (YSH)

---

## âš¡ PAYMENT METHOD COMPARISON

```tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Method      â”‚     Fee      â”‚  Settlement  â”‚   Advance    â”‚ Installments â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Boleto         â”‚ R$ 1.89      â”‚ 1 day        â”‚ 4.19%/month  â”‚ No           â”‚
â”‚                â”‚ (fixed)      â”‚              â”‚ (2-3 days)   â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Credit Card    â”‚ 2.89%-5.58%  â”‚ 30 days      â”‚ 1.89%/month  â”‚ Yes (1-21x)  â”‚
â”‚ (1x)           â”‚ 2.89%        â”‚              â”‚ (2-3 days)   â”‚              â”‚
â”‚ (2-6x)         â”‚ 3.12%        â”‚              â”‚              â”‚              â”‚
â”‚ (7-12x)        â”‚ 3.44%        â”‚              â”‚              â”‚              â”‚
â”‚ (13-21x)       â”‚ 5.58%        â”‚              â”‚              â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Debit Card     â”‚ 1.89%        â”‚ 3 days       â”‚ N/A          â”‚ No           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PIX Dynamic    â”‚ R$ 1.89      â”‚ ~10 seconds  â”‚ N/A          â”‚ No           â”‚
â”‚                â”‚ (fixed)      â”‚              â”‚              â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PIX Static     â”‚ R$ 1.89      â”‚ ~10 seconds  â”‚ N/A          â”‚ No           â”‚
â”‚                â”‚ (fixed)      â”‚              â”‚              â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â­ RECOMMENDED: PIX (fastest, lowest fee)
```

---

## ğŸ¯ CONCLUSION

Estes diagramas ilustram:

âœ… **Arquitetura em camadas** (Frontend â†’ API â†’ Workflows â†’ Models â†’ Asaas)  
âœ… **Fluxo completo** de pagamento (17 steps, cliente â†’ YSH â†’ Asaas â†’ Recipients)  
âœ… **Workflow detalhado** com 6 steps independentes  
âœ… **Split distribution** visual com valores reais  
âœ… **Database schema** simplificado  
âœ… **Cost breakdown** mapping para splits  
âœ… **Payment methods** comparison table  

**Sistema Production-Ready com TransparÃªncia Total!** ğŸš€
