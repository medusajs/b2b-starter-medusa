# ğŸŒŠ YSH Data Pipeline - Complete Data Flows & Workflows

**Date**: October 14, 2025  
**Version**: 1.0.0  
**Purpose**: Comprehensive documentation of all data flows, workflows, and system integrations

---

## ğŸ“‹ Table of Contents

- [ğŸŒŠ YSH Data Pipeline - Complete Data Flows \& Workflows](#-ysh-data-pipeline---complete-data-flows--workflows)
  - [ğŸ“‹ Table of Contents](#-table-of-contents)
  - [ğŸ—ï¸ System Architecture Overview](#ï¸-system-architecture-overview)
    - [High-Level Architecture](#high-level-architecture)
  - [ğŸŒŠ Data Flow Diagrams](#-data-flow-diagrams)
    - [1. Daily Full Ingestion Flow](#1-daily-full-ingestion-flow)
    - [2. Hourly Incremental Check Flow](#2-hourly-incremental-check-flow)
    - [3. Fallback Recovery Flow](#3-fallback-recovery-flow)
  - [ğŸ”„ Processing Pipelines](#-processing-pipelines)
    - [Data Processing Pipeline](#data-processing-pipeline)
  - [ğŸ’¾ Storage Strategies](#-storage-strategies)
    - [Multi-Layer Storage Architecture](#multi-layer-storage-architecture)
    - [Data Flow Between Storage Layers](#data-flow-between-storage-layers)

---

## ğŸ—ï¸ System Architecture Overview

### High-Level Architecture

```tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EXTERNAL DATA SOURCES                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  ANEEL APIs      â”‚  Utility Portals     â”‚  PDF Documents   â”‚  Manufacturers â”‚
â”‚  â”œâ”€ RSS 2.0      â”‚  â”œâ”€ CPFL            â”‚  â”œâ”€ NBR Standardsâ”‚  â”œâ”€ Fortlev    â”‚
â”‚  â”œâ”€ DCAT US 1.1  â”‚  â”œâ”€ Enel            â”‚  â”œâ”€ Resolutions  â”‚  â”œâ”€ Fotus      â”‚
â”‚  â”œâ”€ DCAT AP 2/3  â”‚  â”œâ”€ Energisa        â”‚  â””â”€ Manuals      â”‚  â”œâ”€ Neosolar   â”‚
â”‚  â”œâ”€ Search API   â”‚  â”œâ”€ Cemig           â”‚                  â”‚  â””â”€ Odex       â”‚
â”‚  â””â”€ CKAN API     â”‚  â””â”€ Light           â”‚                  â”‚                â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚                  â”‚
         â–¼                     â–¼                   â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           INGESTION LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  ANEEL Fetcher   â”‚  Crawlee Scraper     â”‚  PDF Extractor   â”‚  CSV Parser    â”‚
â”‚  (392 lines)     â”‚  (450 lines)         â”‚  (300 lines)     â”‚  (200 lines)   â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  â€¢ Async HTTP    â”‚  â€¢ Playwright        â”‚  â€¢ PyMuPDF       â”‚  â€¢ Pandas      â”‚
â”‚  â€¢ RSS parsing   â”‚  â€¢ JavaScript        â”‚  â€¢ Regex extract â”‚  â€¢ Validation  â”‚
â”‚  â€¢ Rate limiting â”‚  â€¢ Smart navigation  â”‚  â€¢ Table parsing â”‚  â€¢ Mapping     â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     ORCHESTRATION & SCHEDULING       â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Airflow     â”‚  Node-RED  â”‚  Step   â”‚
         â”‚  3 DAGs      â”‚  Flows     â”‚  Fns    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚              â”‚          â”‚
                â–¼              â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PROCESSING LAYER                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  Data Processor  â”‚  AI Enrichment       â”‚  Validator       â”‚  Normalizer    â”‚
â”‚  (280 lines)     â”‚  (450 lines)         â”‚  (250 lines)     â”‚  (200 lines)   â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  â€¢ Deduplication â”‚  â€¢ Ollama LLM        â”‚  â€¢ INMETRO check â”‚  â€¢ Field map   â”‚
â”‚  â€¢ Merging       â”‚  â€¢ Categorization    â”‚  â€¢ ANEEL rules   â”‚  â€¢ Type cast   â”‚
â”‚  â€¢ Transformationâ”‚  â€¢ Keyword extract   â”‚  â€¢ PVLIB calc    â”‚  â€¢ Sanitize    â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           STORAGE LAYER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  PostgreSQL      â”‚  DynamoDB            â”‚  S3              â”‚  Redis         â”‚
â”‚  (Structured)    â”‚  (Cache/NoSQL)       â”‚  (Objects)       â”‚  (Cache)       â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  â€¢ Products      â”‚  â€¢ Latest ingestion  â”‚  â€¢ Raw JSON      â”‚  â€¢ API cache   â”‚
â”‚  â€¢ Tariffs       â”‚  â€¢ Fallback data     â”‚  â€¢ Processed     â”‚  â€¢ Session     â”‚
â”‚  â€¢ Generation    â”‚  â€¢ TTL auto-expire   â”‚  â€¢ Images        â”‚  â€¢ 5-min TTL   â”‚
â”‚  â€¢ Certs         â”‚                      â”‚  â€¢ Documents     â”‚                â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VECTOR STORE LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Qdrant Vector Database                                                      â”‚
â”‚  â€¢ Semantic search with embeddings (all-MiniLM-L6-v2)                       â”‚
â”‚  â€¢ 384-dimensional vectors                                                   â”‚
â”‚  â€¢ Cosine similarity matching                                                â”‚
â”‚  â€¢ Collections: datasets, products, manuals                                  â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API GATEWAY LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  FastAPI REST    â”‚  GraphQL             â”‚  WebSocket       â”‚  API Gateway   â”‚
â”‚  (370 lines)     â”‚  (Future)            â”‚  (Real-time)     â”‚  (AWS)         â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  â€¢ 7 endpoints   â”‚  â€¢ Flexible queries  â”‚  â€¢ Live updates  â”‚  â€¢ Rate limit  â”‚
â”‚  â€¢ Pagination    â”‚  â€¢ Nested relations  â”‚  â€¢ Pub/Sub Redis â”‚  â€¢ Auth        â”‚
â”‚  â€¢ Filtering     â”‚  â€¢ Type safety       â”‚  â€¢ Event stream  â”‚  â€¢ Throttle    â”‚
â”‚  â€¢ OpenAPI docs  â”‚                      â”‚                  â”‚                â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CONSUMERS                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  Medusa Backend  â”‚  Next.js Storefront  â”‚  Mobile App      â”‚  Admin Panel   â”‚
â”‚  (E-commerce)    â”‚  (Customer)          â”‚  (Future)        â”‚  (Management)  â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â”‚  â€¢ Product sync  â”‚  â€¢ Product catalog   â”‚  â€¢ Native exp    â”‚  â€¢ Data mgmt   â”‚
â”‚  â€¢ Inventory     â”‚  â€¢ Search            â”‚  â€¢ Offline mode  â”‚  â€¢ Analytics   â”‚
â”‚  â€¢ Pricing       â”‚  â€¢ Calculator        â”‚  â€¢ Push notifs   â”‚  â€¢ Reports     â”‚
â”‚                  â”‚                      â”‚                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒŠ Data Flow Diagrams

### 1. Daily Full Ingestion Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DAILY FULL INGESTION WORKFLOW                             â”‚
â”‚                    Trigger: Cron (02:00 AM daily)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START (02:00 AM)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                           â”‚
    â–¼                                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FETCH ANEEL DATA       â”‚                        â”‚  SCRAPE UTILITIES       â”‚
â”‚  (Parallel execution)   â”‚                        â”‚  (Parallel execution)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ RSS Feed             â”‚                        â”‚  â€¢ CPFL Portal          â”‚
â”‚  â€¢ DCAT Catalogs        â”‚                        â”‚  â€¢ Enel Portal          â”‚
â”‚  â€¢ Search API           â”‚                        â”‚  â€¢ Energisa Portal      â”‚
â”‚  â€¢ Generation data      â”‚                        â”‚  â€¢ Cemig Portal         â”‚
â”‚  â€¢ Tariffs              â”‚                        â”‚  â€¢ Light Portal         â”‚
â”‚  â€¢ Certifications       â”‚                        â”‚                         â”‚
â”‚                         â”‚                        â”‚                         â”‚
â”‚  Output: ~50-200        â”‚                        â”‚  Output: ~100-500       â”‚
â”‚  datasets JSON          â”‚                        â”‚  records JSON           â”‚
â”‚                         â”‚                        â”‚                         â”‚
â”‚  XCom: aneel_datasets   â”‚                        â”‚  XCom: utility_records  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                                  â”‚
             â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚     â”‚
             â–¼     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MERGE & DEDUPLICATE    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ Combine sources      â”‚
    â”‚  â€¢ Remove duplicates    â”‚
    â”‚  â€¢ Resolve conflicts    â”‚
    â”‚  â€¢ Normalize fields     â”‚
    â”‚                         â”‚
    â”‚  Logic:                 â”‚
    â”‚  1. Group by ID         â”‚
    â”‚  2. Keep most recent    â”‚
    â”‚  3. Merge metadata      â”‚
    â”‚                         â”‚
    â”‚  Output: ~150-700       â”‚
    â”‚  unique records         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PROCESS WITH AI        â”‚
    â”‚  (Ollama LLM)           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ Categorize datasets  â”‚
    â”‚  â€¢ Extract keywords     â”‚
    â”‚  â€¢ Generate summaries   â”‚
    â”‚  â€¢ Calculate relevance  â”‚
    â”‚                         â”‚
    â”‚  Model: llama3.2:3b     â”‚
    â”‚  Batch: 20 at a time    â”‚
    â”‚  Timeout: 120s each     â”‚
    â”‚                         â”‚
    â”‚  Enrichment:            â”‚
    â”‚  {                      â”‚
    â”‚    categoria: string    â”‚
    â”‚    palavras_chave: []   â”‚
    â”‚    resumo_curto: str    â”‚
    â”‚    relevancia_ysh: 1-10 â”‚
    â”‚  }                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  VALIDATE & CLEAN       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ INMETRO compliance   â”‚
    â”‚  â€¢ ANEEL regulations    â”‚
    â”‚  â€¢ Technical specs      â”‚
    â”‚  â€¢ Data quality         â”‚
    â”‚                         â”‚
    â”‚  Checks:                â”‚
    â”‚  â€¢ Power rating valid   â”‚
    â”‚  â€¢ Dates consistent     â”‚
    â”‚  â€¢ Location valid       â”‚
    â”‚  â€¢ URLs accessible      â”‚
    â”‚                         â”‚
    â”‚  Output: Clean + marked â”‚
    â”‚  validation flags       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                     â”‚
                 â–¼                                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  INDEX IN VECTOR STORE  â”‚          â”‚  SAVE TO DATABASES      â”‚
    â”‚  (Qdrant)               â”‚          â”‚  (PostgreSQL + Dynamo)  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ Generate embeddings  â”‚          â”‚  PostgreSQL:            â”‚
    â”‚  â€¢ Store vectors        â”‚          â”‚  â€¢ INSERT products      â”‚
    â”‚  â€¢ Update collections   â”‚          â”‚  â€¢ UPDATE tariffs       â”‚
    â”‚                         â”‚          â”‚  â€¢ UPSERT generation    â”‚
    â”‚  Embedding model:       â”‚          â”‚                         â”‚
    â”‚  all-MiniLM-L6-v2       â”‚          â”‚  DynamoDB:              â”‚
    â”‚  Dimension: 384         â”‚          â”‚  â€¢ PUT latest state     â”‚
    â”‚  Similarity: Cosine     â”‚          â”‚  â€¢ TTL: 24 hours        â”‚
    â”‚                         â”‚          â”‚                         â”‚
    â”‚  Indexed: ~150-700 docs â”‚          â”‚  S3:                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â€¢ JSON backup          â”‚
                 â”‚                       â”‚  â€¢ Timestamped files    â”‚
                 â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  UPDATE CACHE           â”‚
                     â”‚  (Redis)                â”‚
                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                     â”‚  â€¢ SET last_run         â”‚
                     â”‚  â€¢ SET dataset_count    â”‚
                     â”‚  â€¢ SET status           â”‚
                     â”‚  â€¢ TTL: 6 hours         â”‚
                     â”‚                         â”‚
                     â”‚  Keys:                  â”‚
                     â”‚  - ysh:last_ingestion   â”‚
                     â”‚  - ysh:dataset_count    â”‚
                     â”‚  - ysh:status           â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  SEND NOTIFICATIONS     â”‚
                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                     â”‚  â€¢ Email summary        â”‚
                     â”‚  â€¢ SNS publish          â”‚
                     â”‚  â€¢ Slack webhook        â”‚
                     â”‚                         â”‚
                     â”‚  Content:               â”‚
                     â”‚  - Datasets processed   â”‚
                     â”‚  - Errors encountered   â”‚
                     â”‚  - Execution time       â”‚
                     â”‚  - Next run scheduled   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                              SUCCESS
                         (Duration: ~15-20 min)
```

### 2. Hourly Incremental Check Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  HOURLY INCREMENTAL CHECK WORKFLOW                           â”‚
â”‚                  Trigger: Cron (00 * * * * - every hour)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START (Every hour)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHECK FOR UPDATES      â”‚
â”‚  (BranchPythonOperator) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Logic:                 â”‚
â”‚  1. Query Redis         â”‚
â”‚     last_run timestamp  â”‚
â”‚                         â”‚
â”‚  2. Check RSS feed      â”‚
â”‚     for new items since â”‚
â”‚     last_run            â”‚
â”‚                         â”‚
â”‚  3. Query Search API    â”‚
â”‚     modified:[lastrun   â”‚
â”‚     TO now]             â”‚
â”‚                         â”‚
â”‚  Decision:              â”‚
â”‚  â€¢ new_datasets > 0     â”‚
â”‚    â†’ process_updates    â”‚
â”‚  â€¢ new_datasets == 0    â”‚
â”‚    â†’ skip_processing    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
         â”Œâ”€â”€â”€â”´â”€â”€â”€â”
         â”‚       â”‚
    YES  â”‚       â”‚  NO
         â”‚       â”‚
         â–¼       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PROCESS UPDATES        â”‚     â”‚  SKIP PROCESSING        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ Fetch new datasets   â”‚     â”‚  â€¢ Log "No updates"     â”‚
    â”‚  â€¢ AI enrichment        â”‚     â”‚  â€¢ Update Redis         â”‚
    â”‚  â€¢ Validation           â”‚     â”‚    check_timestamp      â”‚
    â”‚  â€¢ Index in Qdrant      â”‚     â”‚  â€¢ Exit gracefully      â”‚
    â”‚  â€¢ Save to DB           â”‚     â”‚                         â”‚
    â”‚  â€¢ Update cache         â”‚     â”‚  Duration: ~5 seconds   â”‚
    â”‚                         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  Output: Incremental    â”‚
    â”‚  update summary         â”‚
    â”‚                         â”‚
    â”‚  Duration: ~3-5 min     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  LOG SUMMARY            â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  â€¢ New datasets: N      â”‚
            â”‚  â€¢ Updated: M           â”‚
            â”‚  â€¢ Errors: E            â”‚
            â”‚  â€¢ Duration: Xs         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
             SUCCESS
```

### 3. Fallback Recovery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FALLBACK RECOVERY WORKFLOW                               â”‚
â”‚                     Trigger: Manual or Auto (on failure)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START (Error detected)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HEALTH CHECK SERVICES  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Redis connection     â”‚
â”‚  â€¢ PostgreSQL query     â”‚
â”‚  â€¢ Ollama endpoint      â”‚
â”‚  â€¢ S3 access            â”‚
â”‚  â€¢ DynamoDB read        â”‚
â”‚                         â”‚
â”‚  Status: {              â”‚
â”‚    redis: UP/DOWN       â”‚
â”‚    postgres: UP/DOWN    â”‚
â”‚    ollama: UP/DOWN      â”‚
â”‚  }                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TRY PRIMARY SOURCE     â”‚
â”‚  (ANEEL API)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Endpoint:              â”‚
â”‚  dadosabertos-aneel...  â”‚
â”‚                         â”‚
â”‚  Timeout: 30s           â”‚
â”‚  Retry: 3 times         â”‚
â”‚  Backoff: 2^n seconds   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
         â”Œâ”€â”€â”€â”´â”€â”€â”€â”
         â”‚       â”‚
    SUCCESSâ”‚     â”‚ FAILURE
         â”‚       â”‚
         â–¼       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  USE PRIMARY DATA       â”‚     â”‚  WAIT 60 SECONDS        â”‚
    â”‚  (Fresh from API)       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
    â”‚  â€¢ Process normally     â”‚                  â–¼
    â”‚  â€¢ Update cache         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â€¢ Clear fallback flags â”‚     â”‚  TRY RSS FEED           â”‚
    â”‚                         â”‚     â”‚  (Alternative source)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚                  â”‚  Endpoint:              â”‚
                 â”‚                  â”‚  .../api/feed/rss/2.0   â”‚
                 â”‚                  â”‚                         â”‚
                 â”‚                  â”‚  Timeout: 30s           â”‚
                 â”‚                  â”‚  Retry: 3 times         â”‚
                 â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                               â”‚
                 â”‚                           â”Œâ”€â”€â”€â”´â”€â”€â”€â”
                 â”‚                           â”‚       â”‚
                 â”‚                      SUCCESSâ”‚     â”‚ FAILURE
                 â”‚                           â”‚       â”‚
                 â”‚                           â–¼       â–¼
                 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚  USE RSS DATA           â”‚     â”‚  WAIT 60 SECONDS        â”‚
                 â”‚              â”‚  (Limited metadata)     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
                 â”‚              â”‚  â€¢ Parse feed           â”‚                  â–¼
                 â”‚              â”‚  â€¢ Basic enrichment     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚  â€¢ Mark as fallback     â”‚     â”‚  USE CACHED DATA        â”‚
                 â”‚              â”‚                         â”‚     â”‚  (Last successful run)  â”‚
                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚                           â”‚                  â”‚  Source:                â”‚
                 â”‚                           â”‚                  â”‚  â€¢ Redis cache          â”‚
                 â”‚                           â”‚                  â”‚  â€¢ DynamoDB latest      â”‚
                 â”‚                           â”‚                  â”‚  â€¢ S3 backup            â”‚
                 â”‚                           â”‚                  â”‚                         â”‚
                 â”‚                           â”‚                  â”‚  Age check:             â”‚
                 â”‚                           â”‚                  â”‚  â€¢ If > 7 days old      â”‚
                 â”‚                           â”‚                  â”‚    â†’ CRITICAL ALERT     â”‚
                 â”‚                           â”‚                  â”‚  â€¢ If < 7 days old      â”‚
                 â”‚                           â”‚                  â”‚    â†’ Use with warning   â”‚
                 â”‚                           â”‚                  â”‚                         â”‚
                 â”‚                           â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                           â”‚                               â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  NOTIFY FALLBACK USED   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚  â€¢ Email alert          â”‚
                    â”‚  â€¢ SNS high severity    â”‚
                    â”‚  â€¢ Log to CloudWatch    â”‚
                    â”‚                         â”‚
                    â”‚  Message:               â”‚
                    â”‚  - Source used          â”‚
                    â”‚  - Data age             â”‚
                    â”‚  - Action needed        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ATTEMPT SERVICE        â”‚
                    â”‚  RESTART (if needed)    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚  Services:              â”‚
                    â”‚  â€¢ Restart Ollama       â”‚
                    â”‚  â€¢ Clear Redis          â”‚
                    â”‚  â€¢ Reconnect PostgreSQL â”‚
                    â”‚                         â”‚
                    â”‚  Logic: Only if health  â”‚
                    â”‚  check showed DOWN      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                            SUCCESS
                    (With fallback marker)
```

---

## ğŸ”„ Processing Pipelines

### Data Processing Pipeline

```
RAW DATA INPUT
    â”‚
    â”œâ”€ ANEELDataset JSON
    â”œâ”€ Utility Scrape HTML
    â”œâ”€ PDF Extract Text
    â””â”€ CSV Product Data
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: NORMALIZATION                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Field Mapping:                                                               â”‚
â”‚  â€¢ title â†’ normalized_title (strip, lowercase, no accents)                  â”‚
â”‚  â€¢ description â†’ clean_description (HTML stripped, 200 char limit)          â”‚
â”‚  â€¢ date fields â†’ ISO 8601 datetime                                           â”‚
â”‚  â€¢ numeric fields â†’ float with validation                                    â”‚
â”‚                                                                               â”‚
â”‚  Type Casting:                                                                â”‚
â”‚  â€¢ String â†’ enforce UTF-8                                                     â”‚
â”‚  â€¢ Numbers â†’ float/int with bounds check                                     â”‚
â”‚  â€¢ Dates â†’ datetime with timezone                                            â”‚
â”‚  â€¢ Arrays â†’ list with type validation                                        â”‚
â”‚                                                                               â”‚
â”‚  Example:                                                                     â”‚
â”‚  IN:  {"title": "  PAINEL SOLAR 440W  ", "power": "440"}                   â”‚
â”‚  OUT: {"title": "painel solar 440w", "power_w": 440.0}                     â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: DEDUPLICATION                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Strategies:                                                                  â”‚
â”‚                                                                               â”‚
â”‚  1. Exact Match (by ID)                                                       â”‚
â”‚     â€¢ Hash: MD5(id)                                                          â”‚
â”‚     â€¢ Action: Keep most recent by modified date                              â”‚
â”‚                                                                               â”‚
â”‚  2. Fuzzy Match (by title + metadata)                                         â”‚
â”‚     â€¢ Algorithm: Levenshtein distance < 5                                    â”‚
â”‚     â€¢ Fields: title, manufacturer, model                                     â”‚
â”‚     â€¢ Action: Merge if score > 0.85                                          â”‚
â”‚                                                                               â”‚
â”‚  3. Semantic Match (by embeddings)                                            â”‚
â”‚     â€¢ Model: all-MiniLM-L6-v2                                                â”‚
â”‚     â€¢ Threshold: Cosine similarity > 0.90                                    â”‚
â”‚     â€¢ Action: Flag as potential duplicate for review                         â”‚
â”‚                                                                               â”‚
â”‚  Rules:                                                                       â”‚
â”‚  â€¢ Prefer: ANEEL data > utility data > manual entry                          â”‚
â”‚  â€¢ Merge: Combine non-conflicting metadata                                   â”‚
â”‚  â€¢ Conflict: Keep most authoritative source                                  â”‚
â”‚                                                                               â”‚
â”‚  Example:                                                                     â”‚
â”‚  A: {id: "123", title: "Painel 440W", source: "aneel"}                      â”‚
â”‚  B: {id: "456", title: "Painel 440w", source: "fortlev"}                    â”‚
â”‚  â†’ MERGED: {id: "123", title: "Painel 440W", alt_id: "456"}                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: VALIDATION                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Technical Validation:                                                        â”‚
â”‚                                                                               â”‚
â”‚  â€¢ Power Rating:                                                              â”‚
â”‚    - Solar panels: 100W - 700W                                               â”‚
â”‚    - Inverters: 1kW - 100kW                                                  â”‚
â”‚    - Batteries: 1kWh - 50kWh                                                 â”‚
â”‚                                                                               â”‚
â”‚  â€¢ Efficiency:                                                                â”‚
â”‚    - Solar panels: 15% - 23%                                                 â”‚
â”‚    - Inverters: 94% - 99%                                                    â”‚
â”‚                                                                               â”‚
â”‚  â€¢ Voltage:                                                                   â”‚
â”‚    - MPPT range: 50V - 1000V                                                 â”‚
â”‚    - Output: 110V, 127V, 220V, 380V                                          â”‚
â”‚                                                                               â”‚
â”‚  Regulatory Validation:                                                       â”‚
â”‚                                                                               â”‚
â”‚  â€¢ INMETRO Certification:                                                     â”‚
â”‚    - Check cert number format                                                â”‚
â”‚    - Verify not expired                                                      â”‚
â”‚    - Match manufacturer                                                      â”‚
â”‚                                                                               â”‚
â”‚  â€¢ ANEEL Compliance:                                                          â”‚
â”‚    - NBR 16690:2019 (installations)                                          â”‚
â”‚    - NBR 16274:2014 (systems)                                                â”‚
â”‚    - REN 1.059/2023 (GD rules)                                               â”‚
â”‚                                                                               â”‚
â”‚  Output: validation_status {                                                 â”‚
â”‚    technical: PASS/FAIL                                                      â”‚
â”‚    regulatory: PASS/FAIL/PENDING                                             â”‚
â”‚    errors: [list of issues]                                                  â”‚
â”‚    warnings: [list of concerns]                                              â”‚
â”‚  }                                                                            â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: AI ENRICHMENT                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  LLM Processing (Ollama llama3.2:3b):                                        â”‚
â”‚                                                                               â”‚
â”‚  Prompt Template:                                                             â”‚
â”‚  """                                                                          â”‚
â”‚  Analise este produto/dataset de energia solar e retorne JSON:               â”‚
â”‚                                                                               â”‚
â”‚  TÃ­tulo: {title}                                                             â”‚
â”‚  DescriÃ§Ã£o: {description}                                                    â”‚
â”‚                                                                               â”‚
â”‚  Retorne:                                                                     â”‚
â”‚  {                                                                            â”‚
â”‚    "categoria": "string (inversor|painel|bateria|kit|...)",                 â”‚
â”‚    "palavras_chave": ["keyword1", "keyword2", ...],                         â”‚
â”‚    "resumo_curto": "string (max 200 chars)",                                â”‚
â”‚    "relevancia_ysh": 1-10,                                                   â”‚
â”‚    "aplicacao": "string (residencial|comercial|industrial)",                â”‚
â”‚    "destaque": "string (unique selling point)"                               â”‚
â”‚  }                                                                            â”‚
â”‚  """                                                                          â”‚
â”‚                                                                               â”‚
â”‚  Parameters:                                                                  â”‚
â”‚  â€¢ temperature: 0.3 (low creativity)                                         â”‚
â”‚  â€¢ top_p: 0.9                                                                â”‚
â”‚  â€¢ max_tokens: 500                                                           â”‚
â”‚  â€¢ timeout: 120 seconds                                                      â”‚
â”‚                                                                               â”‚
â”‚  Batch Processing:                                                            â”‚
â”‚  â€¢ Process 20 items at a time                                                â”‚
â”‚  â€¢ Parallel requests: 3                                                      â”‚
â”‚  â€¢ Retry on timeout: 2 times                                                 â”‚
â”‚                                                                               â”‚
â”‚  Fallback on Error:                                                           â”‚
â”‚  â€¢ Use regex-based categorization                                            â”‚
â”‚  â€¢ Extract keywords from title/description                                   â”‚
â”‚  â€¢ Set relevancia_ysh = 5 (neutral)                                          â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: SEMANTIC INDEXING                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Embedding Generation:                                                        â”‚
â”‚                                                                               â”‚
â”‚  Model: sentence-transformers/all-MiniLM-L6-v2                               â”‚
â”‚  â€¢ Dimensions: 384                                                            â”‚
â”‚  â€¢ Max sequence: 512 tokens                                                  â”‚
â”‚  â€¢ Normalization: L2                                                          â”‚
â”‚                                                                               â”‚
â”‚  Input Text Construction:                                                     â”‚
â”‚  text = f"{title} {description} {' '.join(keywords)}"                       â”‚
â”‚                                                                               â”‚
â”‚  Qdrant Indexing:                                                             â”‚
â”‚  â€¢ Collection: ysh-products                                                  â”‚
â”‚  â€¢ Distance metric: Cosine                                                   â”‚
â”‚  â€¢ HNSW parameters:                                                          â”‚
â”‚    - m: 16                                                                   â”‚
â”‚    - ef_construct: 100                                                       â”‚
â”‚                                                                               â”‚
â”‚  Payload:                                                                     â”‚
â”‚  {                                                                            â”‚
â”‚    "id": "...",                                                              â”‚
â”‚    "title": "...",                                                           â”‚
â”‚    "category": "...",                                                        â”‚
â”‚    "metadata": {...}                                                         â”‚
â”‚  }                                                                            â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              PROCESSED DATA
                           Ready for storage/API
```

---

## ğŸ’¾ Storage Strategies

### Multi-Layer Storage Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STORAGE LAYER ARCHITECTURE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LAYER 1: HOT CACHE (Redis)
â”œâ”€ Purpose: Ultra-fast read access, session data
â”œâ”€ TTL: 5 minutes - 6 hours
â”œâ”€ Data Types: Strings, Hashes, Lists, Sets
â””â”€ Keys:
   â”œâ”€ ysh:api:datasets:{id} â†’ Dataset JSON
   â”œâ”€ ysh:api:search:{hash} â†’ Search results
   â”œâ”€ ysh:last_ingestion â†’ Timestamp
   â”œâ”€ ysh:dataset_count â†’ Counter
   â””â”€ ysh:status:{service} â†’ Health status

LAYER 2: WARM CACHE (DynamoDB)
â”œâ”€ Purpose: Recent data, fallback source
â”œâ”€ TTL: 24 hours (auto-expire)
â”œâ”€ Billing: Pay-per-request
â””â”€ Tables:
   â””â”€ ysh-pipeline-cache
      â”œâ”€ PK: pk (partition key) = "latest" | "ingestion" | "fallback"
      â”œâ”€ SK: sk (sort key) = timestamp | dataset_id
      â”œâ”€ Attributes: JSON blob, metadata
      â””â”€ GSI: By source, by category

LAYER 3: STRUCTURED DATA (PostgreSQL)
â”œâ”€ Purpose: Transactional data, complex queries
â”œâ”€ ACID: Full consistency
â””â”€ Tables:
   â”œâ”€ products (id, sku, name, category, specs, price, ...)
   â”œâ”€ generation_units (unit_id, utility, location, power, ...)
   â”œâ”€ tariffs (tariff_id, utility, class, te, tusd, ...)
   â”œâ”€ certifications (cert_id, equipment_type, manufacturer, ...)
   â””â”€ ingestion_log (run_id, timestamp, status, records, ...)

LAYER 4: OBJECT STORAGE (S3)
â”œâ”€ Purpose: Raw data, backups, large files
â”œâ”€ Lifecycle: 30 days â†’ Glacier, 90 days â†’ Delete
â”œâ”€ Structure:
   â””â”€ ysh-pipeline-data/
      â”œâ”€ raw/
      â”‚  â”œâ”€ aneel/{date}/datasets.json
      â”‚  â”œâ”€ utilities/{utility}/{date}/data.json
      â”‚  â””â”€ pdf/{type}/{filename}.pdf
      â”œâ”€ processed/
      â”‚  â”œâ”€ enriched/{date}/datasets.json
      â”‚  â””â”€ validated/{date}/datasets.json
      â”œâ”€ images/
      â”‚  â””â”€ products/{id}/{filename}.{ext}
      â””â”€ backups/
         â””â”€ {timestamp}/full-backup.tar.gz

LAYER 5: VECTOR STORE (Qdrant)
â”œâ”€ Purpose: Semantic search, similarity matching
â”œâ”€ Collections:
   â”œâ”€ ysh-products (384-dim vectors)
   â”œâ”€ ysh-datasets (384-dim vectors)
   â””â”€ ysh-manuals (384-dim vectors)
â””â”€ Features:
   â”œâ”€ Cosine similarity search
   â”œâ”€ Filtered search (by category, etc.)
   â”œâ”€ Multi-vector search (hybrid)
   â””â”€ Payload storage (metadata)
```

### Data Flow Between Storage Layers

```
WRITE PATH:
-----------

   Airflow/Lambda
        â”‚
        â–¼
   1. Redis (cache)
      - SET with 5-min TTL
      - Pub/Sub notify
        â”‚
        â–¼
   2. DynamoDB (warm)
      - PutItem with TTL
      - For fallback
        â”‚
        â–¼
   3. PostgreSQL (structured)
      - INSERT/UPDATE/UPSERT
      - Transactional
        â”‚
        â–¼
   4. S3 (archive)
      - PutObject
      - Versioning enabled
        â”‚
        â–¼
   5. Qdrant (vectors)
      - Upsert points
      - With payload


READ PATH (API Request):
------------------------

   FastAPI Endpoint
        â”‚
        â–¼
   1. Check Redis
      â”œâ”€ HIT â†’ Return (fastest)
      â””â”€ MISS â†“
              â”‚
              â–¼
   2. Query PostgreSQL
      â”œâ”€ Found â†’ Cache to Redis â†’ Return
      â””â”€ Not Found â†“
                    â”‚
                    â–¼
   3. Check DynamoDB
      â”œâ”€ Found â†’ Return (fallback data)
      â””â”€ Not Found â†“
                    â”‚
                    â–¼
   4. Query S3 (rare)
      â””â”€ Return latest backup


SEMANTIC SEARCH PATH:
---------------------

   Search Query
        â”‚
        â–¼
   1. Generate Embedding
      (sentence-transformers)
        â”‚
        â–¼
   2. Query Qdrant
      - Top K similar vectors
      - With filters
        â”‚
        â–¼
   3. Fetch Full Data
      â”œâ”€ Try Redis cache
      â””â”€ Fallback PostgreSQL
        â”‚
        â–¼
   4. Return Ranked Results
```

---

*[Document continues with sections on API Data Flows, Orchestration Patterns, Error Handling, Caching, and Monitoring...]*

**Next sections to complete**:

- API Gateway Data Flows (REST + WebSocket)
- Orchestration Patterns (Airflow vs Node-RED vs Step Functions)
- Complete Error Handling Strategies
- Caching Invalidation Patterns
- Monitoring & Observability Setup

This document is now at **~1,100 lines**. Continue with remaining sections?
