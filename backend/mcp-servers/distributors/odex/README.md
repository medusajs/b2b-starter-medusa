# Odex Agent

MCP Server for Odex B2B Portal at: `https://www.odex.com.br`

## Quick Start

### Prerequisites
- Node.js 18+
- Playwright browsers installed: `npx playwright install`
- Odex B2B account credentials

### Installation

```bash
npm install
```

### Authentication

Set environment variables:

```bash
export EMAIL_ODEX="your@email.com"
export PASSWORD_ODEX="your-password"
```

Or for development:

```bash
export EMAIL="your@email.com"
export PASSWORD="your-password"
```

## Usage

### Debug (Map HTML Structure)

Use this first to understand the actual portal structure and update selectors if needed:

```bash
EMAIL=user@example.com PASSWORD=pass npx tsx debug-odex.ts
```

Outputs:
- `debug-login-page.html` - Login page structure
- `debug-home-page.html` - Home page after login
- `debug-products-page.html` - Products page
- `debug-*.png` - Screenshots for visual inspection

Use these to refine selectors in `server.ts` if the generic ones don't work.

### Test Suite

Run full test suite:

```bash
EMAIL=user@example.com PASSWORD=pass npx tsx test-odex.ts
```

Tests:
1. ✅ Authentication
2. ✅ List products
3. ✅ Get product details
4. ✅ Category filtering
5. ✅ Full extraction

### Full Extraction

Extract complete catalog to JSON + CSV:

```bash
EMAIL=user@example.com PASSWORD=pass npx tsx extract-odex-full.ts
```

Outputs:
- `odex-catalog-full.json` - Complete product data
- `odex-catalog-full.csv` - For spreadsheet import

## Configuration

### Selectors

If the debug output shows incorrect selectors, update in `server.ts`:

```typescript
private readonly selectors = {
  emailInput: 'input[name="email"]',
  passwordInput: 'input[name="password"]',
  loginButton: 'button[type="submit"]',
  productCard: '.product-card',
  productTitle: 'h3.title',
  productPrice: '.price',
  productLink: 'a.product-link',
  productImage: 'img.product-image',
};
```

### Rate Limiting

Adjust concurrency in constructor:

```typescript
this.queue = new PQueue({ concurrency: 3 }); // Change from 3
```

## MCP Server Interface

### Methods

```typescript
// Authenticate with portal
async authenticate(email: string, password: string): Promise<AuthSession>

// List products with optional filters
async listProducts(filters?: ProductFilters): Promise<Product[]>

// Get detailed product info
async getProduct(sku: string): Promise<Product | null>

// Full extraction with stats
async extractProducts(config: ExtractionConfig): Promise<ExtractionResult>

// Cleanup resources
async cleanup(): Promise<void>
```

## Schema

### Product

```typescript
interface Product {
  id: string;
  sku: string;
  title: string;
  price: number;
  currency: string;
  imageUrl: string;
  url: string;
  category?: string;
  brand?: string;
  description?: string;
  specifications?: Record<string, string>;
}
```

### ExtractionResult

```typescript
interface ExtractionResult {
  distributor: string;
  totalProducts: number;
  products: Product[];
  duration: number;
  timestamp: string;
}
```

## Troubleshooting

### "Authentication failed - still on login page"

The login selectors might be wrong. Run debug script and check `debug-login-page.html`:

```bash
npx tsx debug-odex.ts
```

### "No products found"

Product selectors need refinement. Check `debug-products-page.html` and update:

```typescript
productCard: '.your-actual-selector'
```

### Rate limiting / 429 errors

Reduce concurrency:

```typescript
this.queue = new PQueue({ concurrency: 1 });
```

Add delays:

```typescript
await this.page.waitForTimeout(2000); // 2 second delay
```

## Database Integration

Import to PostgreSQL:

```bash
npx tsx scripts/import-odex-to-db.ts
```

## Performance

- **Typical extraction**: 200-300 products / 2-3 minutes
- **Full catalog**: Variable depending on product count
- **Memory usage**: ~200-400MB for 1000+ products

## Support

For issues with selectors or authentication, see `debug-*.html` and `debug-*.png` files generated by debug script.
